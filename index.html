<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sade Sohbet — Emoji & Renkli Odalar</title>
<style>
body{margin:0;font-family:sans-serif;background:#f0f0f0;color:#111}
.container{max-width:800px;margin:20px auto;padding:10px;background:#fff;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.header, .composer{display:flex;gap:6px;flex-wrap:wrap;justify-content:space-between;margin-bottom:12px;}
.header > div, .composer > *{flex:1;min-width:120px;}
.rooms{margin-bottom:12px;display:flex;flex-wrap:wrap;gap:6px;}
.room{padding:8px;border-radius:6px;background:#eee;cursor:pointer;flex:1;min-width:100px;text-align:center;}
.room.active{background:#cceeff;}
.chat{border:1px solid #ddd;border-radius:6px;padding:10px;height:300px;overflow:auto;margin-bottom:10px;word-break:break-word;}
.input{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;}
.btn{padding:8px 10px;border:none;border-radius:6px;background:#0077ff;color:#fff;cursor:pointer;width:100%;}
.user-label{display:inline-flex;align-items:center;gap:6px;margin-right:6px;}
.avatar{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700;}
@media(max-width:500px){
  .chat{height:250px;}
  .room{flex:1 1 45%;}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <input class="input" id="username" placeholder="Kullanıcı adı"/>
      <button class="btn" id="btnLogin">Hesap Oluştur</button>
    </div>
    <div>
      <input class="input" id="newRoomName" placeholder="Yeni oda"/>
      <button class="btn" id="btnCreateRoom">Oluştur</button>
    </div>
  </div>
  <div class="rooms" id="rooms"></div>
  <div class="chat" id="chatWindow"></div>
  <div class="composer">
    <input class="input" id="messageInput" placeholder="Mesaj yaz... (emoji kullanabilirsiniz)"/>
    <button class="btn" id="sendBtn">Gönder</button>
  </div>
</div>

<script>
// -------------------------
// State ve BroadcastChannel
// -------------------------
const STORAGE_KEY='chat_app_state';
let state={
  username:null,
  rooms:[{id:'general',name:'Genel',color:'#0077ff'}],
  currentRoom:'general',
  messages:{general:[]},
  users:{} // kullanıcı renk ve avatar
};

// LocalStorage’dan yükle
const saved = localStorage.getItem(STORAGE_KEY);
if(saved){
  try{
    const obj=JSON.parse(saved);
    if(obj.rooms) state.rooms=obj.rooms;
    if(obj.messages) state.messages=obj.messages;
    if(obj.currentRoom) state.currentRoom=obj.currentRoom;
    if(obj.users) state.users=obj.users;
  }catch(e){}
}

// Rastgele renk üret
function randomColor(name){
  let hash=0;
  for(let i=0;i<name.length;i++){hash=name.charCodeAt(i)+((hash<<5)-hash);}
  const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
  return '#'+('00000'+c).slice(-6);
}

// Kullanıcı avatar
function getAvatar(name){
  if(!state.users[name]){
    state.users[name]={color:randomColor(name),initial:name[0].toUpperCase()};
    saveState();
  }
  return state.users[name];
}

// BroadcastChannel ile çoklu sekme
let channel=null;
if('BroadcastChannel' in window){
  channel = new BroadcastChannel('chat_channel');
  channel.onmessage = function(e){
    const msg = e.data;
    if(msg.type==='message'){
      const room=msg.room;
      state.messages[room] = state.messages[room] || [];
      state.messages[room].push(msg.payload);
      saveState();
      if(room===state.currentRoom) renderChat();
    } else if(msg.type==='newRoom'){
      const r = msg.room;
      if(!state.rooms.find(x=>x.id===r.id)){
        state.rooms.push(r);
        state.messages[r.id]=[];
        saveState();
        renderRooms();
      }
    }
  };
}

// -------------------------
// DOM Elements
// -------------------------
const el=id=>document.getElementById(id);

// -------------------------
// Save & Render Functions
// -------------------------
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}

function renderRooms(){
  const wrap=el('rooms');
  wrap.innerHTML='';
  state.rooms.forEach(r=>{
    const div=document.createElement('div');
    div.className='room'+(r.id===state.currentRoom?' active':'');
    div.innerText=r.name;
    div.style.background = r.color || '#eee';
    div.onclick=()=>{state.currentRoom=r.id;renderRooms();renderChat();}
    wrap.appendChild(div);
  });
}

function renderChat(){
  const win=el('chatWindow');
  win.innerHTML='';
  const msgs=state.messages[state.currentRoom]||[];
  msgs.forEach(m=>{
    const avatar=getAvatar(m.from);
    const d=document.createElement('div');
    // mesaj içindeki emoji unicode desteklenir, direkt göster
    d.innerHTML=`<span class="user-label"><span class="avatar" style="background:${avatar.color}">${avatar.initial}</span> <b style="color:${avatar.color}">${m.from}</b>:</span> ${m.text}`;
    win.appendChild(d);
  });
  win.scrollTop=win.scrollHeight;
}

// -------------------------
// Event Handlers
// -------------------------
el('btnLogin').onclick=()=>{
  const name=el('username').value.trim();
  if(!name){alert('Kullanıcı adı gir!');return;}
  state.username=name;
  getAvatar(name); // avatar oluştur
  el('username').disabled=true;
  el('btnLogin').disabled=true;
  renderRooms();
  renderChat();
}

el('btnCreateRoom').onclick=()=>{
  const name=el('newRoomName').value.trim();
  if(!name){alert('Oda adı gir!');return;}
  const id=name.toLowerCase().replace(/\s+/g,'_');
  const color=randomColor(name);
  const newRoom={id,name,color};
  state.rooms.push(newRoom);
  state.currentRoom=id;
  state.messages[id]=[];
  el('newRoomName').value='';
  renderRooms();
  renderChat();
  saveState();
  if(channel) channel.postMessage({type:'newRoom',room:newRoom});
}

el('sendBtn').onclick=()=>{
  if(!state.username){alert('Önce hesap oluştur!');return;}
  const text=el('messageInput').value.trim();
  if(!text) return;
  const room=state.currentRoom;
  const msg = {from:state.username,text};
  state.messages[room]=state.messages[room]||[];
  state.messages[room].push(msg);
  el('messageInput').value='';
  renderChat();
  saveState();
  if(channel) channel.postMessage({type:'message',room:room,payload:msg});
}

// Enter ile gönderme
el('messageInput').addEventListener('keypress',e=>{if(e.key==='Enter'){el('sendBtn').click();}});
el('newRoomName').addEventListener('keypress',e=>{if(e.key==='Enter'){el('btnCreateRoom').click();}});
el('username').addEventListener('keypress',e=>{if(e.key==='Enter'){el('btnLogin').click();}});

// -------------------------
// Başlangıçta render
// -------------------------
renderRooms();
renderChat();
</script>
</body>
</html>
